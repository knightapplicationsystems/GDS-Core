var win;var source;var soundcloudUsername;var soundcloudClientID;var displayOption;var artist;var alertMessage;var failureMessage;var actInd;var activityWindow;var activityBg;var imgNav;var url;var coverFlow;var images=[];var trackTitle;var lblTrackTitle;var sound;var streamURL;var trackDesc;var trackID;var borders;var textColor;var lblUnableToConnect;var btnRetry;var btnRefresh;var dlURL;var btnLib;var id;win=Ti.UI.currentWindow;loadConfig();Ti.API.warn('Audio Page Load');function loadConfig(){var file=Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory,'config/config.xml');var xmltext=file.read().text;var doc=Ti.XML.parseString(xmltext);var soundcloudElement=doc.documentElement.getElementsByTagName("soundcloud");var artistElement=doc.documentElement.getElementsByTagName("artist");var sourceElement=doc.documentElement.getElementsByTagName("audioSource");var styleElement=doc.documentElement.getElementsByTagName("colorScheme");for(var i=0;i<artistElement.length;i++){var item=artistElement.item(i);artist=item.getAttributes().getNamedItem("name").nodeValue;}
for(var i=0;i<sourceElement.length;i++){var item=sourceElement.item(i);source=item.getAttributes().getNamedItem("source").nodeValue;displayOption=item.getAttributes().getNamedItem("displayOption").nodeValue;}
for(var i=0;i<soundcloudElement.length;i++){var item=soundcloudElement.item(i);soundcloudUsername=item.getAttributes().getNamedItem("username").nodeValue;soundcloudClientID=item.getAttributes().getNamedItem("clientID").nodeValue;}
for(var i=0;i<styleElement.length;i++){var item=styleElement.item(i);borders=item.getAttributes().getNamedItem("borderColor").nodeValue;textColor=item.getAttributes().getNamedItem("textColor").nodeValue;Ti.API.warn(textColor);}}
win.backgroundImage="/images/background.png";Ti.Media.defaultAudioSessionMode=Ti.Media.AUDIO_SESSION_MODE_PLAYBACK;alertMessage=Ti.UI.createAlertDialog({title:artist,message:'Alert Message'});failureMessage=Ti.UI.createAlertDialog({title:artist,message:'Alert Message'});function showIndicator(){actInd=Ti.UI.createActivityIndicator({style:Ti.UI.iPhone.ActivityIndicatorStyle.BIG,message:'Loading...',color:'white',height:60,width:'auto'});activityWindow=Ti.UI.createWindow({width:200,height:100});activityBg=Ti.UI.createView({backgroundColor:"#000000",opacity:0.8,borderRadius:10});activityWindow.add(activityBg);activityWindow.add(actInd);activityWindow.open();actInd.show();}
function hideIndicator(){activityWindow.close();}
imgNav=Ti.UI.createLabel({top:0,text:'SHOWS',height:'30dp',width:'320dp',left:0,textAlign:'center',color:textColor,backgroundImage:'/images/blank.png',font:{fontStyle:'Sans Serif',fontSize:20}});win.barImage='/images/header.png';btnRefresh=Ti.UI.createButton({image:'/images/arrow_circle_right.png',top:3,right:10,height:'25dp',width:'25dp',zIndex:20})
btnRefresh.addEventListener('click',function(e){images=[];lblTrackTitle.text='';win.remove(coverFlow);callService();});win.add(btnRefresh);if(source=='soundcloud'){url='https://api.soundcloud.com/users/'+soundcloudUsername+'/tracks.json?client_id='+soundcloudClientID;callService();}
lblTrackTitle=Ti.UI.createLabel({color:'White',textAlign:'center',left:10,top:'75dp',height:18,width:300,font:{fontWeight:'bold',fontSize:13}});win.add(lblTrackTitle);function callService(){showIndicator();var xhr=Ti.Network.createHTTPClient();xhr.onload=serviceResponse;xhr.onerror=serviceError;xhr.open("GET",url);xhr.setRequestHeader('Content-Type','application/json');xhr.send();}
function serviceResponse(){var hostResp;hostResp=JSON.parse(this.responseText);for(var i in hostResp){var str=hostResp[i].artwork_url;var diffImage=str.replace('large','t500x500');Ti.API.warn(diffImage);var name=diffImage;images[i]={image:name,width:155,height:155};}
coverFlow=Ti.UI.iOS.createCoverFlowView({images:images,top:'31dp'});hideIndicator();coverFlow.addEventListener('change',function(e){trackTitle=hostResp[e.index].title;trackID=hostResp[e.index].id;var preStrippedText;preStrippedText=trackTitle;var strippedText=preStrippedText.replace('Global Dance Session','');fStripped=strippedText.replace(' on','');lblTrackTitle.text=fStripped;});coverFlow.addEventListener('click',function(e){trackTitle=hostResp[e.index].title;streamURL=hostResp[e.index].stream_url;trackDesc=hostResp[e.index].description;dlURL=hostResp[e.index].download_url;showTrackList();Ti.API.warn(streamURL);});win.add(coverFlow);}
function springPlayer(){sound=Ti.Media.createVideoPlayer({mediaControlStyle:Ti.Media.VIDEO_CONTROL_DEFAULT,fullscreen:false,height:'20dp',top:'55dp',allowBackground:true});sound.url=streamURL+'?client_id='+soundcloudClientID;sound.autoplay=true;win.add(sound);}
function showTrackList(){var t=Ti.UI.create2DMatrix();t=t.scale(0);var w=Ti.UI.createWindow({backgroundColor:'black',borderWidth:5,borderColor:borders,height:400,width:320,borderRadius:10,opacity:0.95,transform:t});var t1=Ti.UI.create2DMatrix();t1=t1.scale(1.1);var a=Ti.UI.createAnimation();a.transform=t1;a.duration=200;a.addEventListener('complete',function(){Ti.API.info('here in complete');var t2=Ti.UI.create2DMatrix();t2=t2.scale(1.0);w.animate({transform:t2,duration:200});});var strDesc=trackDesc;strDesc=strDesc.replace(/<br>/gi,"\n");strDesc=strDesc.replace(/<a.*href="(.*?)".*>(.*?)<\/a>/gi," $2 ($1) ");strDesc=strDesc.replace(/<(?:.|\s)*?>/g,"");strDesc=strDesc.replace(/\&amp;/g,'&');strDesc=strDesc.replace(/\#/g,'');strDesc=strDesc.replace(/&8216/g,'');strDesc=strDesc.replace(/&8217/g,'');strDesc=strDesc.replace(/&8211/g,'');strDesc=strDesc.replace(/&8221/g,'');strDesc=strDesc.replace(/&13/g,'');strDesc=strDesc.replace(/;/g,'');var scrollView=Ti.UI.createScrollView({top:'0dp',height:'auto'});var lblTrackDesc=Ti.UI.createLabel({top:'46dp',left:10,height:'auto',width:'300dp',text:strDesc,font:{fontSize:'13dp',fontFamily:'Arial',},color:'White'});var b=Ti.UI.createButton({title:'Done',height:30,top:'8dp',width:90,right:10,backgroundColor:'black',color:'black'});var download=Ti.UI.createButton({title:'Download',height:30,top:'8dp',width:90,left:115,backgroundColor:'black',color:'black'});var play=Ti.UI.createButton({title:'Stream',height:30,top:'8dp',width:90,left:10,backgroundColor:'black',color:'black'});scrollView.add(lblTrackDesc);scrollView.add(play);scrollView.add(b);w.add(scrollView);play.addEventListener('click',function(e){springPlayer();});b.addEventListener('click',function(){var t3=Ti.UI.create2DMatrix();t3=t3.scale(0);w.close({transform:t3,duration:300});});download.addEventListener('click',function(e){alertMessage.message='Downloading, please wait, do not close this screen';alertMessage.buttonNames=[];alertMessage.show();var newDir=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,'scDownloads');newDir.createDirectory();id=fStripped;var dlXhr=Ti.Network.createHTTPClient({});dlXhr.onload=function(){var file=Ti.Filesystem.getFile(newDir.resolve(),id+'.mp3');Ti.API.warn('file is: '+file);Ti.API.warn('RespData is: '+this.responseData);file.createFile();Ti.API.warn(dlXhr.status);if(dlXhr.status==200){try{file.write(this.responseData);alertMessage.hide();var t3=Ti.UI.create2DMatrix();t3=t3.scale(0);w.close({transform:t3,duration:300});switchToLib();}catch(e){}}}
dlXhr.onerror=function(e){Ti.API.warn(e.error);Ti.API.debug(e.error);Ti.API.warn('JSON ERROR= '+JSON.stringify(e));Ti.API.warn('Client Status='+dlXhr.status);if(dlXhr.status==403){alertMessage.hide();alertMessage.message('Sorry unable to download file - 403 Error');alertMessage.show();}
alertMessage.message='Sorry this file is not available to download';alertMessage.show();}
var encUri=Ti.Network.encodeURIComponent(trackTitle+'.mp3');dlXhr.open('GET','http://www.globaldancesession.com/GDS_APP_ARCHIVES/'+encUri);Ti.API.warn('http://www.globaldancesession.com/GDS_APP_ARCHIVES/'+encUri);dlXhr.setRequestHeader('Content-Type','application/json');dlXhr.setTimeout([500000]);dlXhr.send();Ti.API.warn('newdir '+newDir);});w.open(a);}
function serviceError(){hideIndicator();failureMessage.message="Unable to connect to "+source+", Please try again later (For best results use a 3G or WiFi connection)";failureMessage.show();lblUnableToConnect=Ti.UI.createLabel({text:'Sorry we are unable to connect you to '+source+' at this time, please try again later',height:'auto',top:80,left:10,color:'White',font:{fontSize:15,fontStyle:'normal'},textAlign:'center'});btnRetry=Ti.UI.createButton({top:170,left:10,width:300,height:40,color:textColor,title:'Retry',font:{fontSize:15,fontFamily:'Arial',fontWeight:'bold'},backgroundImage:'/images/blank.png'});win.add(btnRetry,lblUnableToConnect);btnRetry.addEventListener('click',function(e){if(lblUnableToConnect.visible=true){lblUnableToConnect.visible=false;}
if(btnRetry.visible=true){btnRetry.visible=false;}
callService();});}
btnLib=Ti.UI.createButton({bottom:10,left:10,width:300,height:40,color:textColor,title:'Download Library',font:{fontSize:15,fontFamily:'Arial',fontWeight:'bold'},backgroundImage:'/images/blank.png',zIndex:2});btnLib.addEventListener('click',function(e){switchToLib();})
function switchToLib(){var lib=Ti.UI.createWindow({url:'library.js'});Ti.UI.currentTab.open(lib,{transition:Ti.UI.iPhone.AnimationStyle.FLIP_FROM_RIGHT});}
win.add(imgNav);